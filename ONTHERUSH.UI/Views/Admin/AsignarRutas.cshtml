@using ONTHERUSH.AccesoADatos.Models
@{
    Layout = null;

    var conductores = ViewBag.Conductores as IList<ApplicationUser>;
    var reservas = ViewBag.Reservas as List<Reserva>;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asignar rutas - ON THE RUSH</title>

    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/pages/admin-asignar-rutas.css" />
</head>

<body>
    <div class="wrap">
        <h2>Asignar rutas</h2>
        <div style="margin-bottom:15px;">
            <a asp-controller="Admin"asp-action="PanelAdministrador"class="btn-link btn-secondary">
                ← Volver al panel
            </a>
        </div>
        <div class="hint">Selecciona un conductor, marca reservas y define el orden de recogida.</div>

        @if (TempData["Exito"] != null)
        {
            <div class="ok">@TempData["Exito"]</div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="err">@TempData["Error"]</div>
        }

        <div class="card">
            <form asp-action="AsignarRutas" asp-controller="Admin" method="post" id="formAsignar">
                @Html.AntiForgeryToken()

                <div class="row">
                    <div>
                        <label><b>Conductor</b></label><br />
                        <select name="conductorId" style="min-width:340px;">
                            @foreach (var c in conductores)
                            {
                                <option value="@c.Id">@c.Email</option>
                            }
                        </select>
                        <div class="hint">Se asignará la lista al conductor seleccionado.</div>
                    </div>

                    <button type="submit" class="btn">Asignar ruta</button>
                </div>

                <div class="small">
                    Tip: Orden = 1,2,3... según el recorrido. Ubicación = Provincia / Cantón / Distrito.
                </div>

                <div style="margin-top:12px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Seleccionar</th>
                                <th>Reserva</th>
                                <th>Ubicación</th>
                                <th>Orden</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < reservas.Count; i++)
                            {
                                var r = reservas[i];

                                <tr>
                                    <td>
                                        <input type="checkbox"                          class="chkReserva"                 data-index="@i" />
                                    </td>

                                    <td>
                                        <div><b>Reserva #@r.ReservaId</b></div>
                                        <div class="pill">@r.FechaReserva.ToString("dd/MM/yyyy HH:mm")</div>
                                        <div class="pill">@r.Estado</div>
                                    </td>

                                    <td>
                                        <div>@r.Provincia, @r.Canton, @r.Distrito</div>
                                    </td>

                                    <td>
                                        <input type="number"                        class="txtOrden"                                            data-index="@i"                                    value="@(i + 1)"                            min="1"
                                               style="width:90px;" />
                                    </td>

                                    <td style="display:none;">
                                        <input type="hidden" id="realid_@i" value="@r.ReservaId" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>

    <script>
            const form = document.getElementById("formAsignar");

            form.addEventListener("submit", function (e) {

                // Borra inputs dinámicos previos (si intenta 2 veces)
                document.querySelectorAll(".dyn-input").forEach(x => x.remove());

                const checks = document.querySelectorAll(".chkReserva");
                let seleccionados = 0;

                checks.forEach(chk => {
                    const i = chk.getAttribute("data-index");

                    const realId = document.getElementById("realid_" + i).value;
                    const orden = document.querySelector(".txtOrden[data-index='" + i + "']").value;

                    if (chk.checked) {
                        seleccionados++;

                        // reservaIds[]
                        const rid = document.createElement("input");
                        rid.type = "hidden";
                        rid.name = "reservaIds";
                        rid.value = realId;
                        rid.classList.add("dyn-input");
                        form.appendChild(rid);

                        // ordenes[]
                        const ord = document.createElement("input");
                        ord.type = "hidden";
                        ord.name = "ordenes";
                        ord.value = orden;
                        ord.classList.add("dyn-input");
                        form.appendChild(ord);
                    }
                });

                if (seleccionados === 0) {
                    e.preventDefault();
                    alert("Debes seleccionar al menos una reserva.");
                }
            });
    </script>
</body>

</html>